import csv
import time
import os
from bs4 import BeautifulSoup
import requests
import codecs
from fake_useragent import UserAgent
from random import choice



# 代理ip
proxys = ["112.85.130.10:9999","113.120.34.108:9999","112.85.167.250:9999","117.28.96.212:9999","182.116.225.142:9999","58.20.79.188:8118","163.204.245.254:9999","60.13.42.234:9999","121.233.226.97:9999","163.204.247.240:9999","120.83.107.73:9999","60.13.42.15:9999","163.204.245.15:9999","60.13.42.95:9999","222.93.105.7:8118","60.13.42.210:9999","60.13.42.26:9999","27.43.189.4:9999","112.85.129.100:9999","60.13.42.28:9999","60.169.114.242:808","60.13.42.182:9999","111.226.211.21:8118","115.202.156.187:39589","61.135.155.82:443","163.204.244.48:9999","113.124.93.32:9999","42.159.91.248:8080","60.13.42.203:9999","183.166.20.169:9999","163.204.242.121:9999","113.128.11.235:61234","163.204.244.56:9999","120.83.107.6:9999","120.84.100.40:9999","112.85.129.176:9999","27.44.222.124:80","60.13.42.223:9999","163.204.243.14:9999","125.120.176.18:9999","163.204.247.14:9999","112.80.41.86:8888","101.89.64.246:8080","111.231.140.109:8888","111.231.94.44:8888","182.96.46.187:8118","111.231.90.122:8888","111.231.92.21:8888","61.128.208.94:3128","218.64.69.79:8080","218.66.253.144:8800","218.66.253.145:8800","58.246.3.178:53281","111.231.93.66:8888","124.237.83.14:53281","58.20.37.25:8181","218.66.253.146:8800","112.80.41.78:8888","112.80.41.79:8888","120.26.208.102:88","58.249.55.222:9797","120.79.172.37:8118","223.156.112.100:9000","210.26.49.88:3128","121.15.254.156:888","60.205.159.195:3128","123.206.204.51:8118","59.44.247.194:9797","116.204.152.110:8080","58.17.125.215:53281","116.196.90.176:3128","121.17.174.121:9797","113.140.1.82:53281","111.198.154.116:8888","61.145.182.27:53281","42.228.3.158:8080","139.224.21.138:80","112.250.107.37:53281","120.76.191.177:8118","111.230.254.195:8118","121.10.141.149:8080","49.51.155.45:8081","116.196.90.181:3128","221.7.255.168:8080","120.25.90.253:8118","182.61.175.77:8118","116.62.215.123:8118","118.89.44.224:8118","121.232.199.179:9000","58.251.233.234:9797","221.122.91.61:8080","221.122.91.60:8080","119.23.175.107:1086","211.147.65.154:80","112.85.130.10:9999","222.132.41.192:9999","60.13.42.15:9999","60.13.42.95:9999","113.247.252.114:9090","120.78.225.5:3128","112.80.41.86:8888","222.93.105.7:8118","101.89.64.246:8080","27.43.189.4:9999","112.85.129.100:9999","27.191.234.69:9999","60.13.42.26:9999","122.4.29.17:61234","111.226.211.21:8118","115.202.156.187:39589","175.16.20.48:80","111.231.92.21:8888","42.159.91.248:8080","183.166.20.169:9999","120.26.208.102:88","112.85.129.176:9999","60.211.218.78:53281","27.44.222.124:80","60.13.42.223:9999","163.204.243.14:9999","163.204.247.246:9999","113.121.21.4:9999","163.204.245.39:9999","112.85.130.47:9999","123.57.61.38:8118","112.80.41.78:8888","112.80.41.79:8888","163.204.241.204:9999","163.204.241.226:9999","182.35.81.60:9999","182.35.86.229:9999","60.13.42.187:9999","163.204.242.167:9999","121.33.220.158:808","210.26.64.44:3128","163.204.240.165:9999","125.120.176.18:9999","113.120.34.108:9999","163.204.245.254:9999","121.233.226.97:9999","175.11.195.119:8118","182.116.225.142:9999","117.28.96.212:9999","120.83.107.73:9999","218.95.37.252:3128","163.204.247.240:9999","60.13.42.234:9999","163.204.245.113:9999","163.204.245.15:9999","180.154.173.175:8118","60.13.42.210:9999","60.13.42.28:9999","111.231.140.109:8888","60.169.114.242:808","111.231.94.44:8888","60.13.42.182:9999","180.160.54.117:8118","61.135.155.82:443","111.231.90.122:8888","163.204.244.48:9999","113.124.93.32:9999","101.93.154.137:9000","60.13.42.203:9999","163.204.242.121:9999","163.204.244.56:9999","222.223.162.133:3128","120.83.107.6:9999","163.204.242.135:9999","119.5.164.149:61234","120.84.100.40:9999","163.204.247.14:9999","60.13.42.159:9999","111.231.93.66:8888","60.13.42.105:9999","182.35.87.130:9999","182.34.34.234:9999","60.13.42.147:9999","111.230.99.192:8118","163.204.240.154:9999","59.44.247.194:9797","60.13.42.201:9999"]
#1.使用python random模块的choice方法随机选择某个元素
proxy = choice(proxys)

proxy_d = "http://"+proxy

proxies = {
	"http":proxy_d
}




# csv路径
csv_path = "./bbb_no_data.csv"
# 读取csv文件
csv_file = csv.reader(open(csv_path,'r',encoding='UTF-8'))

# 设置一个集合
# 注意：创建一个空集合必须用 set() 而不是 { }，因为 { } 是用来创建一个空字典。
# xxx in data 判断xxx是否在集合中存在
# data = set()
# 循环文件所有内容http://www.haicj.com/carinfo.jsp?clxh=SVW7183MJi&typeid=2

# 写 csv
def write_csv(data):
	file = "aaa.csv"

	with codecs.open(file,'a',encoding='utf-8') as f:
		f.write(data+"\n")
		f.close()


def get_haicj(url,xh,cjh):

	# 随机产生User-Agent
	User_Agent = UserAgent()
	ua = User_Agent.random

	headers = {
		
		"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3",
		"Accept-Encoding": "gzip, deflate",
		"Accept-Language": "zh-CN,zh;q=0.9",
		"Cache-Control": "max-age=0",
		"Connection": "keep-alive",
		"Cookie": "SearchType=vin; PHPSESSID=s23shso201lj9cn27k3qi7acff; Hm_lvt_d6d66a78d863e895c324e752879449ea=1566315806,1566324441; Hm_lpvt_d6d66a78d863e895c324e752879449ea=1566324441",
		"Host": "www.yiparts.com",
		"Upgrade-Insecure-Requests": "1",
		"User-Agent": ua,

	}

	rs = requests.get(url, headers=headers, proxies=proxies, verify=False)
	# rs = requests.get(url, headers=headers, verify=False)
	rs.encoding = 'utf-8'
	data = BeautifulSoup(rs.text, "lxml")

	if len(data.select("#vin_form > div:nth-child(2) > div.txt_main.imgcodebox > input")) > 0:
		if "imgcode" in data.select("#vin_form > div:nth-child(2) > div.txt_main.imgcodebox > input")[0].get("name"):
			print("需要手工验证, 1")
			input_str = input("");
			if input_str == "1":
				print("Received input is : ", input_str  )
				get_haicj(url,xh,cjh)


	tr_list = data.select("#Main > table > tbody > tr")
	if len(data.select("#Main > div.nodata")) < 1 and len(tr_list) > 0:
		data_ = ""
		add = ""
		for x in range(1,len(tr_list)+1):
			if len(data.select("#Main > table > tbody > tr:nth-child("+str(x)+")")) > 0:
				title = data.select("#Main > table > tbody > tr:nth-child("+str(x)+")")[0].get("class")
				if "MarkDiffTr" in title:
					pingpai = data.select("#Main > table > tbody > tr:nth-child("+str(x)+") > td:nth-child(1)")[0].getText().strip()
					print(pingpai)
					chexi = data.select("#Main > table > tbody > tr:nth-child("+str(x)+") > td:nth-child(3)")[0].getText().strip()
					print(chexi)
					nianfen = data.select("#Main > table > tbody > tr:nth-child("+str(x)+") > td:nth-child(4)")[0].getText().strip()
					mingche = data.select("#Main > table > tbody > tr:nth-child("+str(x)+") > td:nth-child(5)")[0].getText().strip()
					xinghao = mingche + " " + nianfen +"款"
					add = add + xinghao + "/"
		data_ = xh + "," + cjh + "," + pingpai + "," + chexi + "," + add
		write_csv(data_)

	else:
		data_ = xh + "," + cjh + ","
		print(data_)
		write_csv(data_)


for line in csv_file:
	cjh = line[1]
	url = "http://www.yiparts.com/vin?type=vin&keyword="+cjh
	get_haicj(url,line[0],cjh)

# get_haicj(url,"","")
	# print(data)
	# # 循环每一行集合数据
	# for su in data:
	# 	print(su)
	# # 清空集合
	# data.clear()